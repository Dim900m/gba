<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GBA Emulator with Zip Loader</title>
  <style>
    #screen {
      image-rendering: pixelated;
      width: 480px;  /* 4x scale of 240x160 */
      height: 320px;
      border: 2px solid black;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <!-- jsGBA emulator core CDN -->
  <script src="https://unpkg.com/jsgba@latest/dist/jsgba.min.js"></script>
</head>
<body>
  <h1>GBA Emulator with Zip Loader</h1>
  <input type="file" id="zipfile" accept=".zip" />
  <p id="status">Load a zipped .gba ROM to start.</p>
  <canvas id="screen" width="240" height="160"></canvas>

  <script>
    const status = document.getElementById('status');
    const canvas = document.getElementById('screen');
    const ctx = canvas.getContext('2d');

    // Create emulator instance
    const gba = new jsGBA();

    // Setup video output to our canvas
    gba.setScreenCanvas(canvas);

    // Start paused (no ROM loaded)
    gba.pause();

    // Load zipped ROM and start emulator
    document.getElementById('zipfile').addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (!file) return;

      status.textContent = 'Reading zip file...';

      try {
        const zip = await JSZip.loadAsync(file);
        const gbaFileName = Object.keys(zip.files).find(name => name.toLowerCase().endsWith('.gba'));
        if (!gbaFileName) {
          status.textContent = 'No .gba file found in zip.';
          return;
        }

        status.textContent = `Extracting ${gbaFileName}...`;
        const gbaFile = zip.file(gbaFileName);
        const romBuffer = await gbaFile.async('arraybuffer');

        status.textContent = `Loading ROM: ${gbaFileName} (${romBuffer.byteLength} bytes)`;

        // Load the ROM to emulator and start
        gba.loadROM(new Uint8Array(romBuffer));
        gba.resume();

        status.textContent = `Emulator running: ${gbaFileName}`;

      } catch (err) {
        status.textContent = 'Error loading zip/ROM: ' + err.message;
        console.error(err);
      }
    });
  </script>
</body>
</html>
