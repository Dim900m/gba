<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>🔥 GBA Emulator (IodineGBA)</title>
  <style>
    body {
      background-color: #111;
      color: white;
      text-align: center;
      font-family: sans-serif;
    }
    canvas {
      border: 3px solid #444;
      image-rendering: pixelated;
      margin-top: 20px;
    }
    #upload-area {
      padding: 20px;
      border: 2px dashed #555;
      margin: 20px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>🎮 GBA Emulator - Fully Working</h1>
  <div id="upload-area">📁 Click or Drag & Drop a .gba or .zip file</div>
  <input type="file" id="romInput" style="display:none" accept=".gba,.zip" />
  <canvas id="emulator_target" width="240" height="160"></canvas>

  <!-- Dependencies -->
  <script src="https://cdn.jsdelivr.net/gh/Endrift/IodineGBA/IodineGBA/IodineGBA.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/Endrift/IodineGBA/IodineGBA/core/GlueCode.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <script>
    const emulator = new IodineGBA();
    const uploadArea = document.getElementById("upload-area");
    const romInput = document.getElementById("romInput");

    // Set canvas target
    emulator.setCanvas(document.getElementById("emulator_target"));

    // Enable audio
    emulator.enableAudio();

    // Setup emulator
    emulator.play();

    // Start ROM from buffer
    function startROMFromBuffer(arrayBuffer) {
      const byteArray = new Uint8Array(arrayBuffer);
      emulator.attachROM(byteArray);
    }

    // Handle dropped or uploaded files
    async function handleFile(file) {
      const buffer = await file.arrayBuffer();

      if (file.name.endsWith(".zip")) {
        const zip = await JSZip.loadAsync(buffer);
        const gbaFile = Object.values(zip.files).find(f => f.name.endsWith(".gba"));
        if (!gbaFile) {
          alert("❌ No .gba file found inside the ZIP.");
          return;
        }
        const gbaBuffer = await gbaFile.async("arraybuffer");
        startROMFromBuffer(gbaBuffer);
      } else if (file.name.endsWith(".gba")) {
        startROMFromBuffer(buffer);
      } else {
        alert("❌ Invalid file type.");
      }
    }

    uploadArea.addEventListener("click", () => romInput.click());
    romInput.addEventListener("change", e => {
      if (e.target.files.length > 0) handleFile(e.target.files[0]);
    });

    uploadArea.addEventListener("dragover", e => {
      e.preventDefault();
      uploadArea.style.borderColor = "#0f0";
    });

    uploadArea.addEventListener("dragleave", () => {
      uploadArea.style.borderColor = "#555";
    });

    uploadArea.addEventListener("drop", e => {
      e.preventDefault();
      uploadArea.style.borderColor = "#555";
      if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
    });
  </script>
</body>
</html>
